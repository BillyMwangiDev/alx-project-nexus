services:
  - type: web
    name: nexus-movie-api
    runtime: python
    plan: starter
    buildCommand: >
      cd Movie-Recommendation-BE && 
      pip install -r requirements.txt && 
      python manage.py collectstatic --no-input &&
      python manage.py migrate
    startCommand: >
      cd Movie-Recommendation-BE && 
      gunicorn config.wsgi:application --bind 0.0.0.0:$PORT --workers 4 --timeout 60
    envVars:
      - key: PYTHON_VERSION
        value: "3.10.14"
      - key: DJANGO_SETTINGS_MODULE
        value: config.settings
      - key: DEBUG
        value: "False"
      - key: ALLOWED_HOSTS
        fromSecret: ALLOWED_HOSTS
      - key: SECRET_KEY
        fromSecret: SECRET_KEY
      - key: TMDB_API_KEY
        fromSecret: TMDB_API_KEY
      - key: DATABASE_URL
        fromDatabase:
          name: nexus-postgres
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: nexus-redis
          property: connectionString
      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: nexus-redis
          property: connectionString
          queryString: "?db=1"
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: redis
          name: nexus-redis
          property: connectionString
          queryString: "?db=2"
      - key: SECURE_SSL_REDIRECT
        value: "True"
      - key: SESSION_COOKIE_SECURE
        value: "True"
      - key: CSRF_COOKIE_SECURE
        value: "True"
      - key: SECURE_HSTS_SECONDS
        value: "31536000"
      - key: SECURE_HSTS_INCLUDE_SUBDOMAINS
        value: "True"
      - key: SECURE_HSTS_PRELOAD
        value: "True"
    healthCheckPath: /api/health/
    domains:
      - your-app.onrender.com

  - type: worker
    name: nexus-celery-worker
    runtime: python
    plan: starter
    buildCommand: >
      cd Movie-Recommendation-BE && 
      pip install -r requirements.txt
    startCommand: >
      cd Movie-Recommendation-BE && 
      celery -A config worker -l info
    envVars:
      - key: PYTHON_VERSION
        value: "3.10.14"
      - key: DJANGO_SETTINGS_MODULE
        value: config.settings
      - key: DEBUG
        value: "False"
      - key: SECRET_KEY
        fromSecret: SECRET_KEY
      - key: TMDB_API_KEY
        fromSecret: TMDB_API_KEY
      - key: DATABASE_URL
        fromDatabase:
          name: nexus-postgres
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: nexus-redis
          property: connectionString
      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: nexus-redis
          property: connectionString
          queryString: "?db=1"
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: redis
          name: nexus-redis
          property: connectionString
          queryString: "?db=2"

  - type: cron
    name: nexus-celery-beat
    runtime: python
    plan: starter
    schedule: "0 * * * *"
    buildCommand: >
      cd Movie-Recommendation-BE && 
      pip install -r requirements.txt
    startCommand: >
      cd Movie-Recommendation-BE && 
      celery -A config beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    envVars:
      - key: PYTHON_VERSION
        value: "3.10.14"
      - key: DJANGO_SETTINGS_MODULE
        value: config.settings
      - key: DEBUG
        value: "False"
      - key: SECRET_KEY
        fromSecret: SECRET_KEY
      - key: TMDB_API_KEY
        fromSecret: TMDB_API_KEY
      - key: DATABASE_URL
        fromDatabase:
          name: nexus-postgres
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: nexus-redis
          property: connectionString
      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: nexus-redis
          property: connectionString
          queryString: "?db=1"
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: redis
          name: nexus-redis
          property: connectionString
          queryString: "?db=2"

databases:
  - name: nexus-postgres
    databaseName: nexus_db
    user: nexus_user
    ipAllowList: []
