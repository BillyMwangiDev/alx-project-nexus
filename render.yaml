# Render Blueprint (Free Tier)
# This file is the single source of truth for your deployment.
# It uses the robust render_build.sh and start.sh scripts.

services:
  # Main Web Service (Django)
  - type: web
    name: nexus-movie-app
    plan: free
    region: frankfurt
    runtime: python
    buildCommand: "./render_build.sh"
    # start.sh handles migrations (with wait loop) and starts Gunicorn
    startCommand: "cd Movie-Recommendation-BE && ./start.sh"
    healthCheckPath: /api/health/
    envVars:
      - key: DJANGO_SETTINGS_MODULE
        value: config.settings
      - key: SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: "False"
      - key: ALLOWED_HOSTS
        value: "nexus-movie-app.onrender.com"
      - key: DATABASE_URL
        fromDatabase:
          name: nexus-database
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: keyvalue
          name: nexus-cache
          property: connectionString
      - key: CELERY_BROKER_URL
        fromService:
          type: keyvalue
          name: nexus-cache
          property: connectionString
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: keyvalue
          name: nexus-cache
          property: connectionString
      - key: CSRF_TRUSTED_ORIGINS
        value: "https://nexus-movie-app.onrender.com"
      - key: CORS_ALLOWED_ORIGINS
        value: "https://nexus-movie-app.onrender.com"
      - key: TMDB_API_KEY
        sync: false
      - key: SHOW_SWAGGER
        value: "True"
      - key: PYTHON_VERSION
        value: "3.11.6"
      - key: WEB_CONCURRENCY
        value: "1"

  # Redis as keyvalue service (Free Tier Valkey)
  - type: keyvalue
    name: nexus-cache
    plan: free
    region: frankfurt
    ipAllowList: []

databases:
  - name: nexus-database
    plan: free
    region: frankfurt
    databaseName: movies_api
    ipAllowList: []
