# Render Blueprint (Free Tier)
# This file is the single source of truth for your deployment.
# It uses the robust render_build.sh and start.sh scripts.

services:
  # Main Web Service (Django)
  - type: web
    name: nexus-movie-api
    plan: free
    runtime: python
    buildCommand: "./render_build.sh"
    # start.sh handles migrations (with wait loop) and starts Gunicorn
    startCommand: "cd Movie-Recommendation-BE && ./start.sh"
    healthCheckPath: /api/health/
    envVars:
      - key: DJANGO_SETTINGS_MODULE
        value: config.settings
      - key: SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: "True"
      - key: ALLOWED_HOSTS
        value: "*"
      - key: DATABASE_URL
        fromDatabase:
          name: nexus-postgres
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: keyvalue
          name: nexus-redis
          property: connectionString
      - key: CELERY_BROKER_URL
        fromService:
          type: keyvalue
          name: nexus-redis
          property: connectionString
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: keyvalue
          name: nexus-redis
          property: connectionString
      - key: CSRF_TRUSTED_ORIGINS
        sync: false
      - key: CORS_ALLOWED_ORIGINS
        sync: false
      - key: TMDB_API_KEY
        sync: false
      - key: SHOW_SWAGGER
        value: "False"
      - key: PYTHON_VERSION
        value: "3.11.6"
      - key: WEB_CONCURRENCY
        value: "1"

  # Redis as keyvalue service (Free Tier Valkey)
  - type: keyvalue
    name: nexus-redis
    plan: free

databases:
  - name: nexus-postgres
    plan: free
    databaseName: movies_api
