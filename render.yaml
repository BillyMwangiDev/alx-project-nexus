# Render Blueprint (Free Tier)
# Single web service hosting Django + lightweight in-process worker (start.sh)
# Free instances supported: Web services, Postgres, Key Value

services:
  - type: web
    name: nexus-movie-api
    runtime: python
    plan: free
    buildCommand: >
      cd Movie-Recommendation-BE && 
      pip install -r requirements.txt && 
      python manage.py collectstatic --no-input &&
      python manage.py migrate
    # Use the combined start script to run Celery (background) and Gunicorn
    startCommand: >
      cd Movie-Recommendation-BE && 
      ./start.sh
    envVars:
      - key: PYTHON_VERSION
        value: "3.10.14"
      - key: DJANGO_SETTINGS_MODULE
        value: config.settings
      - key: DEBUG
        value: "False"
      - key: SECRET_KEY
        generateValue: true
      - key: ALLOWED_HOSTS
        sync: false
      - key: TMDB_API_KEY
        sync: false
      - key: DATABASE_URL
        fromDatabase:
          name: nexus-postgres
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: keyvalue
          name: nexus-redis
          property: connectionString
      - key: CELERY_BROKER_URL
        fromService:
          type: keyvalue
          name: nexus-redis
          property: connectionString
          queryString: "?db=1"
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: keyvalue
          name: nexus-redis
          property: connectionString
          queryString: "?db=2"
      - key: SECURE_SSL_REDIRECT
        value: "True"
      - key: SESSION_COOKIE_SECURE
        value: "True"
      - key: CSRF_COOKIE_SECURE
        value: "True"
      - key: SECURE_HSTS_SECONDS
        value: "31536000"
      - key: SECURE_HSTS_INCLUDE_SUBDOMAINS
        value: "True"
      - key: SECURE_HSTS_PRELOAD
        value: "True"
    healthCheckPath: /api/health/
    domains:
      - your-app.onrender.com

  # Key Value (Redis) - Free instance
  - type: keyvalue
    name: nexus-redis
    plan: free
    ipAllowList: []

databases:
  - name: nexus-postgres
    plan: free
    databaseName: nexus_db

# Notes:
# - Free tier permits only web, Postgres, and keyvalue services.
# - Background workers/cron should be run in-process via `start.sh` on Free.
# - Free Postgres expires after 30 days and has a 1 GB limit.
# - Set ALLOWED_HOSTS and TMDB_API_KEY in the Render Dashboard (they're referenced via sync: false).
