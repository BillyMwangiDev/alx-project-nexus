# Render blueprint (Free Tier compatible)
# - Workers (type: worker) are not allowed on the Free plan.
# - Redis should be defined as a `keyvalue` service.
# - To run background work on the Free plan, run lightweight tasks inside
#   your web service or provide a combined start script (e.g. start.sh).

services:
  # Main Web Service (Django)
  - type: web
    name: movie-recommendation-be
    plan: free
    runtime: python
    buildCommand: "./render_build.sh"
    # Use a combined start script on the Free Tier to run Gunicorn and
    # any lightweight in-process worker logic if needed.
    startCommand: "cd Movie-Recommendation-BE && ./start.sh"
    healthCheckPath: /api/health/
    envVars:
      - key: DJANGO_SETTINGS_MODULE
        value: config.settings
      - key: SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: "True"
      - key: ALLOWED_HOSTS
        value: "*"
      - key: DATABASE_URL
        fromDatabase:
          name: movies-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: keyvalue
          name: movies-redis
          property: connectionString
      - key: CELERY_BROKER_URL
        fromService:
          type: keyvalue
          name: movies-redis
          property: connectionString
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: keyvalue
          name: movies-redis
          property: connectionString
      - key: CSRF_TRUSTED_ORIGINS
        sync: false
      - key: CORS_ALLOWED_ORIGINS
        sync: false
      - key: TMDB_API_KEY
        sync: false
      - key: SHOW_SWAGGER
        value: "False"
      - key: PYTHON_VERSION
        value: "3.11.6"
      - key: WEB_CONCURRENCY
        value: "1"

  # Redis as keyvalue service (allowed on Free plan)
  - type: keyvalue
    name: movies-redis
    plan: free

databases:
  - name: movies-db
    plan: free
    databaseName: movies_api

# Notes:
# - Create a `start.sh` that starts Gunicorn and any lightweight periodic
#   tasks you need. Example `start.sh` (make executable):
#
#   #!/bin/sh
#   gunicorn config.wsgi:application --bind 0.0.0.0:$PORT &
#   # run any lightweight background loop or scheduler here (optional)
#   wait

