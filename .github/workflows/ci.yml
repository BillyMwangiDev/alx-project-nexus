name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Test & Coverage
    runs-on: ubuntu-latest
    
    env:
      DJANGO_SETTINGS_MODULE: config.settings_test
      DEBUG: "False"
      REDIS_URL: redis://localhost:6379/0
    
    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | POETRY_VERSION=1.8.5 python3 -
        echo "$HOME/.local/bin" >> "$GITHUB_PATH"
    
    - name: Configure Poetry
      run: |
        poetry config virtualenvs.create true
        poetry config virtualenvs.in-project true
    
    - name: Cache poetry venv
      uses: actions/cache@v4
      with:
        path: Movie-Recommendation-BE/.venv
        key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}
    
    - name: Install dependencies
      run: |
        cd Movie-Recommendation-BE
        poetry install --no-root
    
    - name: Run Django checks
      env:
        TMDB_API_KEY: test-key-for-ci
        SECRET_KEY: django-insecure-ci-test-key-9c4d7e8f9g0h1i2j3k4l5m6n7o8p9q0r1
        ALLOWED_HOSTS: localhost,127.0.0.1
      run: |
        cd Movie-Recommendation-BE
        poetry run python manage.py check
    
    - name: Run pytest with coverage (min 80%)
      env:
        TMDB_API_KEY: test-key-for-ci
        SECRET_KEY: django-insecure-ci-test-key-9c4d7e8f9g0h1i2j3k4l5m6n7o8p9q0r1
        ALLOWED_HOSTS: localhost,127.0.0.1
      run: |
        cd Movie-Recommendation-BE
        poetry run python -m pytest --cov=apps --cov-report=term-missing:skip-covered --cov-report=xml:coverage.xml --cov-fail-under=80 -v --tb=short 2>&1 | tee test_output.log
    
    - name: Display coverage summary
      if: always()
      run: |
        cd Movie-Recommendation-BE
        echo "=== Coverage Report Summary ==="
        poetry run python -m coverage report --skip-covered || true
        echo ""
        echo "=== Test Output ==="
        tail -50 test_output.log || true
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./Movie-Recommendation-BE/coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: Archive coverage report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: Movie-Recommendation-BE/coverage.xml

  deploy:
    name: Deploy to Render
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Trigger Render deployment
      env:
        RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
      run: |
        if [ -z "$RENDER_DEPLOY_HOOK_URL" ]; then
          echo "Warning: RENDER_DEPLOY_HOOK_URL not configured. Skipping deployment."
          exit 0
        fi
        curl --request POST \
          --url "$RENDER_DEPLOY_HOOK_URL" \
          --header 'Content-Type: application/json' \
          --data '{"ref":"main","message":"Automated deployment from GitHub Actions"}'
    
    - name: Deployment notification
      run: |
        echo "âœ… Deployment to Render triggered successfully."
        echo "Check Render dashboard for deployment status."

  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | POETRY_VERSION=1.8.5 python3 -
        echo "$HOME/.local/bin" >> "$GITHUB_PATH"

    - name: Install dependencies
      run: |
         cd Movie-Recommendation-BE
         poetry install --no-root

    - name: Run flake8
      run: |
        cd Movie-Recommendation-BE
        poetry run flake8 apps/ config/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
        poetry run flake8 apps/ config/ --count --exit-zero --max-complexity=10 --max-line-length=120 --statistics
      continue-on-error: true
    
    - name: Check import sorting with isort
      run: |
        cd Movie-Recommendation-BE
        poetry run isort --check-only apps/ config/ --diff || true
      continue-on-error: true
    
    - name: Check code formatting with black
      run: |
        cd Movie-Recommendation-BE
        poetry run black --check apps/ config/ --line-length=120 || true
      continue-on-error: true
